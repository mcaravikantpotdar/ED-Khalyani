/**
 * PMIS DYNAMIC ENGINE v8.1 - WONDERFUL EDITION
 * Architecture: Fixed-Grid Layout + Multi-Size Field Support
 * Protocol: Atomic Sync + Header Auto-Sync + WYSIWYG Persistence
 */

const DATA_SHEET = "Sheet1";
const CONFIG_SHEET = "App_Config";
const AUTH_SHEET = "App_Password";

function doPost(e) {
  const lock = LockService.getScriptLock();
  try {
    lock.waitLock(10000); 
    const request = JSON.parse(e.postData.contents);
    const action = request.action;

    switch (action) {
      case "getSchema": return createResponse(getSchema());
      case "fetchRecord": return createResponse(fetchRecord(request.pmisCode, request.dob));
      case "atomicUpdate": return createResponse(atomicUpdate(request.pmisCode, request.fieldName, request.value));
      case "register": return createResponse(registerRecord(request.pmisCode, request.dob));
      case "adminAuth": return createResponse(adminAuth(request.password));
      case "updateConfig": return createResponse(updateConfig(request.configData, request.authPassword, request.newPassword));
      default: return createResponse({ status: "error", message: "Invalid action." });
    }
  } catch (err) {
    return createResponse({ status: "error", message: err.toString() });
  } finally {
    lock.releaseLock();
  }
}

function createResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}

function getSchema() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const configSheet = ss.getSheetByName(CONFIG_SHEET);
  if (!configSheet) return { fields: [], status: "error", message: "Config sheet missing." };
  
  const data = configSheet.getDataRange().getDisplayValues();
  if (data.length < 2) return { fields: [], status: "success" };

  const headers = data[0].map(h => h.trim());
  const fields = [];
  for (let i = 1; i < data.length; i++) {
    let fieldObj = {};
    headers.forEach((header, index) => { fieldObj[header] = data[i][index]; });
    if (fieldObj["Field Name"]) fields.push(fieldObj);
  }
  return { fields: fields, status: "success" };
}

function updateConfig(configData, authPassword, newPassword) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  if (!adminAuth(authPassword).authorized) return { status: "error", message: "Unauthorized." };
  
  const configSheet = ss.getSheetByName(CONFIG_SHEET);
  const authSheet = ss.getSheetByName(AUTH_SHEET);
  const dataSheet = ss.getSheetByName(DATA_SHEET);

  // Update Security
  authSheet.clear();
  authSheet.getRange(1, 1).setValue("ADMIN_PASSWORD");
  authSheet.getRange(1, 2).setValue(String(newPassword).trim());

  // Update Config Schema - Removed "New Line", added "Size"
  configSheet.clear();
  const headers = ["Field Name", "Label", "Section", "Type", "Max Chars", "Required", "Size", "Options"];
  configSheet.appendRow(headers);
  
  if (configData.fields) {
    configData.fields.forEach(f => {
      configSheet.appendRow([
        f.fieldName || "", f.label || "", f.section || "", f.type || "Short Text", 
        f.maxChars || "", f.required || "NO", f.size || "Standard", f.options || ""
      ]);
    });
  }

  // Header Auto-Sync (Lossless)
  const currentHeaders = dataSheet.getRange(1, 1, 1, Math.max(1, dataSheet.getLastColumn())).getDisplayValues()[0].map(h => h.trim());
  configData.fields.forEach(f => {
    if (f.fieldName && currentHeaders.indexOf(f.fieldName) === -1) {
      dataSheet.getRange(1, dataSheet.getLastColumn() + 1).setValue(f.fieldName);
    }
  });

  return { status: "success" };
}

function fetchRecord(pmisCode, dob) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(DATA_SHEET);
  const data = sheet.getDataRange().getDisplayValues();
  const headers = data[0].map(h => h.trim());
  const pmisIdx = headers.indexOf("PMIS Code");
  const dobIdx = headers.indexOf("D.O.B.");

  for (let i = 1; i < data.length; i++) {
    if (data[i][pmisIdx] === String(pmisCode).trim()) {
      if (data[i][dobIdx] === String(dob).trim()) {
        let record = { status: "found" };
        headers.forEach((h, idx) => { record[h] = data[i][idx]; });
        return record;
      }
      return { status: "error", message: "Incorrect D.O.B." };
    }
  }
  return { status: "error", message: "PMIS Code not found." };
}

function atomicUpdate(pmisCode, fieldName, value) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(DATA_SHEET);
  const data = sheet.getDataRange().getDisplayValues();
  const headers = data[0].map(h => h.trim());
  const pmisIdx = headers.indexOf("PMIS Code");
  const fieldIdx = headers.indexOf(fieldName);

  if (fieldIdx === -1) return { status: "error", message: "Header mismatch." };

  let processedValue = (fieldName.toLowerCase().includes("email")) ? String(value).toLowerCase().trim() : String(value).toUpperCase().trim();

  for (let i = 1; i < data.length; i++) {
    if (data[i][pmisIdx] === String(pmisCode).trim()) {
      const cell = sheet.getRange(i + 1, fieldIdx + 1);
      cell.setNumberFormat('@').setValue(processedValue);
      return { status: "success" };
    }
  }
  return { status: "error", message: "Record not found." };
}

function registerRecord(pmisCode, dob) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(DATA_SHEET);
  const data = sheet.getDataRange().getDisplayValues();
  const headers = data[0].map(h => h.trim());
  const pmisIdx = headers.indexOf("PMIS Code");
  const dobIdx = headers.indexOf("D.O.B.");

  for (let i = 1; i < data.length; i++) {
    if (data[i][pmisIdx] === String(pmisCode).trim()) return { status: "error", message: "PMIS already exists." };
  }

  let newRow = new Array(headers.length).fill("");
  newRow[pmisIdx] = String(pmisCode).trim();
  newRow[dobIdx] = String(dob).trim();
  sheet.appendRow(newRow);
  sheet.getRange(sheet.getLastRow(), 1, 1, headers.length).setNumberFormat('@');
  return { status: "success", message: "Registration successful." };
}

function adminAuth(inputPassword) {
  const authSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(AUTH_SHEET);
  if (!authSheet) return { authorized: false };
  const masterPassword = authSheet.getDataRange().getDisplayValues()[0][1]; 
  return { authorized: String(inputPassword).trim() === String(masterPassword).trim() };
}
