<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title id="pageTitle">SaaS PMIS Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  
  <style>
    :root { --primary: #1565c0; --accent: #ff9800; --bg: #f8fafc; --text: #1e293b; }
    body { background-color: var(--bg); font-family: 'Inter', sans-serif; color: var(--text); padding-bottom: 50px; }
    
    /* Cinematic Verbose Loader */
    #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .pulse-ring { width: 80px; height: 80px; border: 4px solid #f1f5f9; border-top-color: var(--primary); border-radius: 50%; animation: spin 1s infinite cubic-bezier(0.68, -0.55, 0.27, 1.55); }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #verboseText { margin-top: 25px; font-weight: 600; font-size: 1.1rem; color: var(--primary); height: 1.5rem; text-align: center; }

    /* Atomic Save Button (Slide-in) */
    .field-wrapper { position: relative; margin-bottom: 5px; }
    .atomic-save { 
      position: absolute; right: 10px; top: 12px; opacity: 0; 
      transform: translateX(20px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer; color: var(--primary); background: white; z-index: 5; padding: 2px;
    }
    .atomic-save.show { opacity: 1; transform: translateX(0); }
    
    /* Pro UI Layout */
    .section-card { background: white; padding: 25px; border-radius: 20px; margin-bottom: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); border: 1px solid #e2e8f0; }
    .section-header { font-size: 1.3rem; font-weight: 800; color: var(--primary); margin-bottom: 25px; display: flex; align-items: center; letter-spacing: -0.5px; }
    .section-header i { margin-right: 10px; font-size: 1.5rem; }
    
    .brand-header { background: var(--primary); color: white; padding: 30px; border-radius: 20px; margin-top: 20px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
    
    /* Marks & Badges */
    .percent-badge { position: absolute; right: 45px; top: 18px; background: #2e7d32; color: white; padding: 2px 8px; border-radius: 6px; font-size: 0.75rem; font-weight: 800; display: none; }
    
    .u-case { text-transform: uppercase; }
    .admin-row { border-bottom: 1px solid #f1f5f9; padding: 15px 0; }
  </style>
</head>
<body>

  <div id="loader">
    <div class="pulse-ring"></div>
    <p id="verboseText">Initiating Mother Ship Handshake...</p>
  </div>

  <div id="adminModal" class="modal modal-fixed-footer" style="width: 90%; max-height: 85%;">
    <div class="modal-content">
      <h4><i class="material-icons left">tune</i> Database Orchestrator</h4>
      <p>Configure section mapping and field order precisely.</p>
      <div id="orchestratorList">
        </div>
    </div>
    <div class="modal-footer">
      <button class="btn blue darken-2" onclick="applySchemaUpdate()">Apply Structural Changes</button>
      <button class="modal-close btn-flat">Cancel</button>
    </div>
  </div>

  <div id="setupModal" class="modal">
    <div class="modal-content">
      <h4>Portal Setup</h4>
      <div id="idStep">
        <p>Enter the Google Sheet ID of your blank sheet.</p>
        <div class="input-field"><input type="text" id="setup_sid"><label>Sheet ID</label></div>
        <button class="btn-large blue w100" style="width:100%" onclick="saveSid()">Connect Database</button>
      </div>
      <div id="provisionStep" style="display:none;">
        <p>Sheet connected. Let's build your organization's DNA.</p>
        <div class="input-field"><input type="text" id="setup_org"><label>Organization Name</label></div>
        <div class="input-field"><input type="password" id="setup_pass"><label>Set Admin Password</label></div>
        <button class="btn-large green w100" style="width:100%" onclick="startProvisioning()">Build System Now</button>
      </div>
    </div>
  </div>

  <div class="container" id="appBody" style="display:none;">
    <div class="brand-header">
      <div>
        <h3 id="orgDisplay" style="margin:0; font-weight:900;">...</h3>
        <span id="portalSub" style="opacity:0.8; font-weight:300;">Enterprise PMIS Engine</span>
      </div>
      <i class="material-icons" style="cursor:pointer; font-size:2rem;" onclick="verifyAdminAccess()">settings</i>
    </div>

    <div class="section-card" style="border-left: 8px solid var(--primary);">
      <div class="row" style="margin-bottom:0">
        <div class="input-field col s12 m5"><input type="text" id="auth_pmis"><label>PMIS CODE</label></div>
        <div class="input-field col s12 m5"><input type="text" id="auth_dob" placeholder="DD-MM-YYYY"><label>DATE OF BIRTH</label></div>
        <div class="col s12 m2"><button class="btn-large black waves-effect" style="width:100%; height:54px;" onclick="loadEmployeeData()">LOAD</button></div>
      </div>
    </div>

    <div id="dynamicFormBody"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    const MOTHER_SHIP = 'https://script.google.com/macros/s/AKfycbxk570Yj2DRGZcEWBB2E8BwHZOxDfO6i5TSF_NKyjso65ct2j0pbNiE5edQ-_aAyHi0sQ/exec';
    let SID = localStorage.getItem('pmis_active_sid');
    let SCHEMA_STATE = [];

    window.onload = () => {
      M.Modal.init(document.querySelectorAll('.modal'), {dismissible: false});
      if(!SID) { runVerboseSequence(["Welcome to SaaS PMIS", "Ready for Connection"], () => openSetup()); } 
      else { runInit(); }
    };

    function runInit() {
      runVerboseSequence(["Connecting to Mother Ship...", "Scanning Sheet DNA...", "Mapping UI Components..."], () => {
        callMotherShip({action: 'init', sheetId: SID}, (res) => {
          if(res.needsProvisioning) { openSetup(true); } 
          else {
            SCHEMA_STATE = res.schema;
            document.getElementById('orgDisplay').innerText = res.settings.ORG_NAME;
            renderDynamicUI(res.schema);
            document.getElementById('loader').style.display = 'none';
            document.getElementById('appBody').style.display = 'block';
          }
        });
      });
    }

    function renderDynamicUI(schema) {
      const container = document.getElementById('dynamicFormBody');
      container.innerHTML = '';
      const sections = [...new Set(schema.map(f => f.Section))].sort();
      
      sections.forEach(secName => {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.innerHTML = `<div class="section-header"><i class="material-icons">folder_open</i> ${secName}</div><div class="row" id="sec_${secName.replace(/\s/g,'')}"></div>`;
        container.appendChild(card);
        
        const row = card.querySelector('.row');
        schema.filter(f => f.Section === secName).sort((a,b) => a.Order - b.Order).forEach(f => {
          const wrapper = document.createElement('div');
          wrapper.className = 'input-field col s12 m4 field-wrapper';
          wrapper.innerHTML = `
            <input type="text" name="${f.ID}" class="u-case f-input" data-label="${f.Label}">
            <label>${f.Label}</label>
            ${f.Type === 'MARKS' ? '<span class="percent-badge"></span>' : ''}
            <i class="material-icons atomic-save" onclick="triggerAtomicSave(this)">save</i>
          `;
          row.appendChild(wrapper);
        });
      });
      M.updateTextFields();
      attachBehaviors();
    }

    function attachBehaviors() {
      document.querySelectorAll('.f-input').forEach(input => {
        input.oninput = (e) => {
          const btn = e.target.parentElement.querySelector('.atomic-save');
          btn.classList.add('show');
          btn.innerHTML = 'save';
          btn.style.color = '#1565c0';
          
          if(e.target.name.includes('Marks')) {
            const badge = e.target.parentElement.querySelector('.percent-badge');
            const p = e.target.value.split('/');
            if(p.length === 2 && p[1] > 0) {
              badge.innerText = ((p[0]/p[1])*100).toFixed(1) + '%';
              badge.style.display = 'block';
            }
          }
        };
      });
    }

    function triggerAtomicSave(btn) {
      const input = btn.parentElement.querySelector('input');
      const pmis = document.getElementById('auth_pmis').value;
      if(!pmis) return M.toast({html: 'Load record first!'});

      btn.innerHTML = 'sync';
      btn.style.opacity = '0.5';

      callMotherShip({
        action: 'atomicSave', sheetId: SID, pmis: pmis,
        fieldName: input.name, newValue: input.value.toUpperCase()
      }, (res) => {
        if(res.success) {
          btn.innerHTML = 'check_circle';
          btn.style.color = '#2e7d32';
          btn.style.opacity = '1';
          setTimeout(() => btn.classList.remove('show'), 2000);
        }
      });
    }

    // --- ORCHESTRATOR LOGIC ---
    function verifyAdminAccess() {
      const pass = prompt("Enter Administrator Password:");
      callMotherShip({action: 'init', sheetId: SID}, (res) => {
        if(String(pass) === String(res.settings.ADMIN_PASSWORD)) {
          openOrchestrator(res.schema);
        } else { alert("Access Denied."); }
      });
    }

    function openOrchestrator(schema) {
      const list = document.getElementById('orchestratorList');
      const sections = [...new Set(schema.map(f => f.Section))];
      list.innerHTML = `<div class="row grey-text" style="font-weight:bold;"><div class="col s5">Field Label</div><div class="col s4">Section Dropdown</div><div class="col s3">Order</div></div>`;
      
      schema.forEach(f => {
        const row = document.createElement('div');
        row.className = 'admin-row row';
        row.innerHTML = `
          <div class="col s5" style="padding-top:10px;">${f.Label}</div>
          <div class="col s4">
            <select class="browser-default orchestrate-sec" data-id="${f.ID}">
              ${sections.map(s => `<option value="${s}" ${f.Section === s ? 'selected' : ''}>${s}</option>`).join('')}
            </select>
          </div>
          <div class="col s3"><input type="number" class="orchestrate-ord" value="${f.Order}" data-id="${f.ID}"></div>
        `;
        list.appendChild(row);
      });
      M.Modal.getInstance(document.getElementById('adminModal')).open();
    }

    function applySchemaUpdate() {
      const payload = Array.from(document.querySelectorAll('.orchestrate-sec')).map(sel => {
        const id = sel.dataset.id;
        const ordInput = document.querySelector(`.orchestrate-ord[data-id="${id}"]`);
        return { ID: id, Section: sel.value, Order: parseInt(ordInput.value) };
      });

      document.getElementById('loader').style.display = 'flex';
      callMotherShip({action: 'updateSchema', sheetId: SID, payload: payload}, () => location.reload());
    }

    // --- UTILS ---
    function runVerboseSequence(msgs, onComplete) {
      let i = 0;
      const display = document.getElementById('verboseText');
      const interval = setInterval(() => {
        display.innerText = msgs[i];
        i++;
        if(i >= msgs.length) { clearInterval(interval); onComplete(); }
      }, 1200);
    }

    function callMotherShip(data, cb) {
      fetch(MOTHER_SHIP, { method: 'POST', body: JSON.stringify(data) })
        .then(res => res.json()).then(cb).catch(e => alert("Signal Lost: " + e));
    }

    function openSetup(provisionMode = false) {
      document.getElementById('loader').style.display = 'none';
      if(provisionMode) {
        document.getElementById('idStep').style.display = 'none';
        document.getElementById('provisionStep').style.display = 'block';
      }
      M.Modal.getInstance(document.getElementById('setupModal')).open();
    }

    function saveSid() {
      SID = document.getElementById('setup_sid').value.trim();
      localStorage.setItem('pmis_active_sid', SID);
      location.reload();
    }

    function startProvisioning() {
      const org = document.getElementById('setup_org').value;
      const pass = document.getElementById('setup_pass').value;
      runVerboseSequence(["Deploying Table Structures...", "Initializing 78 Columns...", "Writing Security Protocols..."], () => {
        callMotherShip({action: 'provision', sheetId: SID, orgName: org, password: pass}, () => location.reload());
      });
    }

    function loadEmployeeData() {
      const p = document.getElementById('auth_pmis').value;
      const d = document.getElementById('auth_dob').value;
      document.getElementById('loader').style.display = 'flex';
      callMotherShip({action: 'search', sheetId: SID, pmis: p, dob: d}, (res) => {
        document.getElementById('loader').style.display = 'none';
        if(res.error) return alert(res.error);
        if(res.notFound) return M.toast({html: 'No record found.'});
        Object.keys(res).forEach(k => {
          const el = document.getElementsByName(k)[0];
          if(el) { el.value = res[k]; el.dispatchEvent(new Event('input')); }
        });
        document.querySelectorAll('.atomic-save').forEach(b => b.classList.remove('show'));
        M.updateTextFields();
      });
    }
  </script>
</body>
</html>
