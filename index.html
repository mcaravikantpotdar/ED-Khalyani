<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PMIS Enterprise v7.7</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  
  <style>
    :root { --p: #0f172a; --a: #3b82f6; --s: #10b981; --e: #ef4444; --bg: #f8fafc; }
    body { background-color: var(--bg); font-family: 'Inter', sans-serif; color: #1e293b; overflow-x: hidden; }
    
    /* Cinematic Defensive Loader */
    #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .pulse-ring { width: 70px; height: 70px; border: 4px solid #f1f5f9; border-top-color: var(--a); border-radius: 50%; animation: spin 1s infinite linear; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #vMsg { margin-top: 25px; font-weight: 600; color: var(--p); text-align: center; max-width: 85%; }
    .error-box { background: #fee2e2; color: #b91c1c; padding: 20px; border-radius: 12px; margin-top: 20px; display: none; border: 1px solid #f87171; max-width: 450px; text-align: center; }

    /* Layout & Header */
    .app-header { background: var(--p); color: white; padding: 45px 0; border-radius: 0 0 30px 30px; margin-bottom: 30px; position: relative; box-shadow: 0 10px 15px rgba(0,0,0,0.1); }
    .settings-trigger { position: absolute; top: 20px; right: 25px; cursor: pointer; opacity: 0.6; transition: 0.3s; }
    .settings-trigger:hover { opacity: 1; transform: rotate(45deg); }
    
    /* Section Architecture */
    .section-card { background: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; border: 1px solid #e2e8f0; }
    .section-title { font-size: 1.4rem; font-weight: 800; color: var(--p); margin-bottom: 25px; display: flex; align-items: center; }
    .section-title i { margin-right: 12px; color: var(--a); }

    /* Atomic Save Logic */
    .field-wrapper { position: relative; }
    .atomic-btn { 
      position: absolute; right: 10px; top: 12px; opacity: 0; 
      transform: translateX(15px); transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      cursor: pointer; color: var(--a); background: white; z-index: 5;
    }
    .atomic-btn.visible { opacity: 1; transform: translateX(0); }
    
    /* Orchestrator & Mapping UI */
    .orch-row { border-bottom: 1px solid #f1f5f9; padding: 15px 0; display: flex; align-items: center; }
    .move-btn { cursor: pointer; color: #94a3b8; font-size: 1.8rem; transition: 0.2s; }
    .move-btn:hover { color: var(--a); }
    .cog-btn { cursor: pointer; color: #94a3b8; transition: 0.2s; margin-left: 10px; }
    .cog-btn:hover { color: var(--p); }
    .prop-drawer { background: #f8fafc; padding: 20px; border-radius: 12px; margin-top: 10px; display: none; border: 1px solid #e2e8f0; width: 100%; }
    
    .map-row { border-bottom: 1px solid #eee; padding: 12px 0; display: flex; align-items: center; }
    .u-case { text-transform: uppercase; }
  </style>
</head>
<body>

  <div id="loader">
    <div class="pulse-ring" id="ring"></div>
    <p id="vMsg">Authenticating Mother Ship Link...</p>
    <div id="errorBox" class="error-box"></div>
    <button id="retryBtn" class="btn red accent-4" style="display:none; margin-top:20px;" onclick="location.reload()">Retry Connection</button>
  </div>

  <div id="adminModal" class="modal modal-fixed-footer" style="width: 95%; height: 90%; border-radius: 24px;">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h4><i class="material-icons left blue-text">tune</i> Enterprise Orchestrator</h4>
        <div>
          <button class="btn green accent-4" onclick="createNewColumn()"><i class="material-icons left">add</i> Add Column</button>
          <button class="btn blue darken-3" style="margin-left:8px;" onclick="createNewSection()"><i class="material-icons left">folder_add</i> New Section</button>
        </div>
      </div>
      <ul class="tabs" id="adminTabs">
        <li class="tab col s6"><a class="active" href="#tabOrch">Schema Orchestrator</a></li>
        <li class="tab col s6"><a href="#tabImport">Smart Data Import</a></li>
      </ul>
      
      <div id="tabOrch" style="padding-top:20px;">
        <p class="grey-text">Use arrows to define display sequence. Use settings to modify field logic.</p>
        <div id="orchList"></div>
      </div>
      
      <div id="tabImport" style="padding-top:20px;">
        <h5>Import Intelligence</h5>
        <p>Upload Excel. Columns are auto-mapped based on your database configuration.</p>
        <div class="file-field input-field">
          <div class="btn blue accent-3"><span>Select Excel</span><input type="file" id="xlIn" accept=".xlsx, .xls"></div>
          <div class="file-path-wrapper"><input class="file-path validate" type="text" placeholder="Upload employee records..."></div>
        </div>
        <div id="mappingZone" style="display:none; margin-top:30px; background:white; padding:20px; border-radius:15px; border:1px solid #e2e8f0;">
          <h6>Verify Header Mapping</h6>
          <div id="mappingList"></div>
          <button class="btn-large green accent-4" style="margin-top:25px; width:100%; border-radius:12px;" onclick="runBulkImport()">Execute Import Engine</button>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-close btn-flat">Exit Command Center</button>
    </div>
  </div>

  <div id="appBody" style="display:none;">
    <header class="app-header">
      <div class="container">
        <h3 id="orgHeader" style="margin:0; font-weight:900; letter-spacing:-1.5px;">Portal</h3>
        <p style="margin:0; opacity:0.6; font-size:0.9rem;">Powered by PMIS Mother Ship v7.7</p>
        <i class="material-icons settings-trigger" onclick="launchAdmin()">settings</i>
      </div>
    </header>

    <div class="container">
      <div class="section-card" style="margin-top:-65px; position:relative; z-index:100; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
        <div class="row" style="margin-bottom:0">
          <div class="input-field col s12 m5"><input type="text" id="pmisCode"><label>PMIS CODE</label></div>
          <div class="input-field col s12 m5"><input type="text" id="dobInput" placeholder="DD-MM-YYYY"><label>DATE OF BIRTH</label></div>
          <div class="col s12 m2"><button class="btn-large blue accent-4 w100" style="width:100%; height:54px; border-radius:12px; font-weight:800;" onclick="loadRecord()">LOAD</button></div>
        </div>
      </div>
      <div id="mainForm"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    // PRECISE URL BINDING
    const MOTHER_SHIP = 'https://script.google.com/macros/s/AKfycbxk570Yj2DRGZcEWBB2E8BwHZOxDfO6i5TSF_NKyjso65ct2j0pbNiE5edQ-_aAyHi0sQ/exec';
    let SHEET_ID = localStorage.getItem('pmis_v6_sid');
    let SCHEMA = [];
    let STAGED_DATA = [];

    window.onload = () => {
      M.Modal.init(document.querySelectorAll('.modal'), {dismissible: false});
      M.Tabs.init(document.querySelectorAll('.tabs'));
      if(!SHEET_ID) { 
        SHEET_ID = prompt("Enter Target Google Sheet ID:"); 
        if(SHEET_ID) { localStorage.setItem('pmis_v6_sid', SHEET_ID); location.reload(); }
      } else { startup(); }
    };

    async function startup() {
      verbose("Synchronizing Handshake...");
      callAPI({action: 'checkStatus', sheetId: SHEET_ID}, res => {
        if(res.error) return showCriticalError(res.error);
        if(res.status === "NEW") { 
          verbose("Blank Sheet. Waiting for Provisioning...");
          provisionSystem(); 
        } else { initApp(); }
      });
    }

    function initApp() {
      verbose("Rehydrating Database Schema...");
      callAPI({action: 'init', sheetId: SHEET_ID}, res => {
        if(res.error) return showCriticalError(res.error);
        SCHEMA = res.schema;
        document.getElementById('orgHeader').innerText = res.settings.ORG_NAME;
        renderUI(res.schema);
        document.getElementById('loader').style.display = 'none';
        document.getElementById('appBody').style.display = 'block';
      });
    }

    function renderUI(schema) {
      const container = document.getElementById('mainForm');
      container.innerHTML = '';
      const sections = [...new Set(schema.map(f => f.Section))].sort();
      
      sections.forEach(sec => {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.innerHTML = `<div class="section-title"><i class="material-icons">folder_open</i> ${sec}</div><div class="row"></div>`;
        const row = card.querySelector('.row');
        schema.filter(f => f.Section === sec).sort((a,b)=>a.Order-b.Order).forEach(f => {
          row.innerHTML += `
            <div class="input-field col s12 m4 field-wrapper">
              <input type="text" name="${f.ID}" class="u-case data-input"><label>${f.Label}</label>
              <i class="material-icons atomic-btn" onclick="atomicSave(this)">save</i>
            </div>`;
        });
        container.appendChild(card);
      });
      M.updateTextFields();
      attachInputLogic();
    }

    function attachInputLogic() {
      document.querySelectorAll('.data-input').forEach(input => {
        input.oninput = (e) => {
          const btn = e.target.parentElement.querySelector('.atomic-btn');
          btn.classList.add('visible');
          btn.innerHTML = 'save';
          btn.style.color = '#3b82f6';
        };
      });
    }

    // --- SMART IMPORT MODULE ---
    document.getElementById('xlIn').addEventListener('change', (e) => {
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = (event) => {
        const data = new Uint8Array(event.target.result);
        const wb = XLSX.read(data, {type: 'array'});
        const sheet = wb.Sheets[wb.SheetNames[0]];
        STAGED_DATA = XLSX.utils.sheet_to_json(sheet);
        if(STAGED_DATA.length > 0) buildImportMapper(Object.keys(STAGED_DATA[0]));
      };
      reader.readAsArrayBuffer(file);
    });

    function buildImportMapper(excelHeaders) {
      const list = document.getElementById('mappingList');
      list.innerHTML = '';
      document.getElementById('mappingZone').style.display = 'block';
      excelHeaders.forEach(h => {
        const match = SCHEMA.find(f => f.Label.toLowerCase() === h.toLowerCase());
        list.innerHTML += `
          <div class="map-row row">
            <div class="col s5"><strong>${h}</strong></div>
            <div class="col s1"><i class="material-icons grey-text">arrow_forward</i></div>
            <div class="col s6">
              <select class="browser-default import-sel" data-xl="${h}">
                <option value="">-- Do Not Import --</option>
                ${SCHEMA.map(f => `<option value="${f.ID}" ${match && match.ID === f.ID ? 'selected' : ''}>${f.Label}</option>`).join('')}
              </select>
            </div>
          </div>`;
      });
    }

    function runBulkImport() {
      const selectors = Array.from(document.querySelectorAll('.import-sel'));
      const payload = STAGED_DATA.map(row => {
        let cleanRow = {};
        selectors.forEach(s => { if(s.value) cleanRow[s.value] = row[s.dataset.xl]; });
        return cleanRow;
      });
      document.getElementById('loader').style.display = 'flex';
      verbose("Writing Records to Mother Ship...");
      callAPI({action: 'importData', sheetId: SHEET_ID, payload: payload}, res => {
        if(res.success) { alert(`Import Successful: ${res.count} records added.`); location.reload(); }
      });
    }

    // --- ORCHESTRATOR ACTIONS ---
    function launchAdmin() {
      const p = prompt("Enter Administrative Access Key:");
      callAPI({action: 'init', sheetId: SHEET_ID}, res => {
        if(String(p) === String(res.settings.ADMIN_PASSWORD)) {
          buildAdminOrch();
          M.Modal.getInstance(document.getElementById('adminModal')).open();
        } else alert("Authorization Failed.");
      });
    }

    function buildAdminOrch() {
      const list = document.getElementById('orchList');
      list.innerHTML = '';
      const sections = [...new Set(SCHEMA.map(f => f.Section))];
      SCHEMA.sort((a,b) => a.Order - b.Order).forEach((f, idx) => {
        const row = document.createElement('div');
        row.className = 'orch-row row';
        row.innerHTML = `
          <div class="col s1 center-align">
            <i class="material-icons move-btn" onclick="moveField('up', ${idx})">expand_less</i>
            <i class="material-icons move-btn" onclick="moveField('down', ${idx})">expand_more</i>
          </div>
          <div class="col s5"><strong>${f.Label}</strong></div>
          <div class="col s4 blue-text font-weight-600">${f.Section}</div>
          <div class="col s2 center-align"><i class="material-icons cog-btn" onclick="toggleDrawer('${f.ID}')">settings</i></div>
          <div class="prop-drawer col s12" id="drawer_${f.ID.replace(/\W/g,'')}">
            <div class="row" style="margin-bottom:0">
              <div class="col s6">
                <label>Move to Section</label>
                <select class="browser-default" id="sec_${f.ID.replace(/\W/g,'')}">
                  ${sections.map(s => `<option value="${s}" ${f.Section===s?'selected':''}>${s}</option>`).join('')}
                </select>
              </div>
              <div class="col s6">
                <label>Field Data Type</label>
                <select class="browser-default" id="typ_${f.ID.replace(/\W/g,'')}">
                  <option value="TEXT" ${f.Type==='TEXT'?'selected':''}>Text</option>
                  <option value="DATE" ${f.Type==='DATE'?'selected':''}>Date</option>
                  <option value="DROPDOWN" ${f.Type==='DROPDOWN'?'selected':''}>Dropdown</option>
                </select>
              </div>
              <div class="col s12 mt-2" style="margin-top:15px">
                <button class="btn blue darken-2" onclick="commitFieldUpdate('${f.ID}')">Sync Properties</button>
              </div>
            </div>
          </div>`;
        list.appendChild(row);
      });
    }

    function moveField(dir, idx) {
      const target = dir === 'up' ? idx - 1 : idx + 1;
      if(target < 0 || target >= SCHEMA.length) return;
      document.getElementById('loader').style.display = 'flex';
      callAPI({action: 'swapOrder', sheetId: SHEET_ID, idA: SCHEMA[idx].ID, idB: SCHEMA[target].ID}, () => location.reload());
    }

    function createNewColumn() {
      const label = prompt("Column Display Label:");
      const section = prompt("Assign to Section:");
      if(label && section) {
        document.getElementById('loader').style.display = 'flex';
        callAPI({action: 'addColumn', sheetId: SHEET_ID, payload: {label: label, section: section, type: 'TEXT'}}, () => location.reload());
      }
    }

    function createNewSection() {
      const name = prompt("New Section Name:");
      if(name) alert(`Section "${name}" initialized. You can now map fields to it using the settings cog.`);
    }

    // --- CORE SYSTEM UTILS ---
    function callAPI(data, cb) {
      fetch(MOTHER_SHIP, {method: 'POST', body: JSON.stringify(data)})
        .then(r => r.json()).then(cb)
        .catch(e => showCriticalError("Connection Signal Lost. Please verify Internet and Script Deployment."));
    }

    function verbose(m) { document.getElementById('vMsg').innerText = m; }
    
    function showCriticalError(m) {
      document.getElementById('ring').style.display = 'none';
      document.getElementById('vMsg').style.display = 'none';
      document.getElementById('errorBox').innerText = m;
      document.getElementById('errorBox').style.display = 'block';
      document.getElementById('retryBtn').style.display = 'block';
    }

    function provisionSystem() {
      const org = prompt("Enter Organization Name:");
      const pass = prompt("Set Admin Access Password:");
      if(org && pass) {
        document.getElementById('loader').style.display = 'flex';
        verbose("Deploying 78-Column Architecture...");
        callAPI({action: 'provision', sheetId: SHEET_ID, orgName: org, password: pass}, () => location.reload());
      }
    }

    function loadRecord() {
      const p = document.getElementById('pmisCode').value;
      const d = document.getElementById('dobInput').value;
      if(!p || !d) return alert("Enter PMIS and DOB.");
      document.getElementById('loader').style.display = 'flex';
      callAPI({action: 'search', sheetId: SHEET_ID, pmis: p, dob: d}, res => {
        document.getElementById('loader').style.display = 'none';
        if(res.notFound) return M.toast({html: 'No record matched these credentials.'});
        if(res.error) return alert(res.error);
        Object.keys(res).forEach(k => {
          const input = document.getElementsByName(k)[0];
          if(input) { input.value = res[k]; input.dispatchEvent(new Event('input')); }
        });
        document.querySelectorAll('.atomic-btn').forEach(b => b.classList.remove('visible'));
        M.updateTextFields();
      });
    }

    function atomicSave(btn) {
      const input = btn.parentElement.querySelector('input');
      const pmis = document.getElementById('pmisCode').value;
      btn.innerHTML = 'sync';
      callAPI({action: 'atomicSave', sheetId: SHEET_ID, pmis: pmis, fieldName: input.name, newValue: input.value.toUpperCase()}, () => {
        btn.innerHTML = 'check_circle'; btn.style.color = '#10b981';
        setTimeout(() => btn.classList.remove('visible'), 2000);
      });
    }

    function toggleDrawer(id) {
      const d = document.getElementById('drawer_' + id.replace(/\W/g,''));
      d.style.display = d.style.display === 'block' ? 'none' : 'block';
    }

    function commitFieldUpdate(id) {
      const s = document.getElementById('sec_' + id.replace(/\W/g,'')).value;
      const t = document.getElementById('typ_' + id.replace(/\W/g,'')).value;
      const f = SCHEMA.find(x => x.ID === id);
      callAPI({action: 'updateField', sheetId: SHEET_ID, payload: {ID: id, Section: s, Type: t, Order: f.Order}}, () => location.reload());
    }
  </script>
</body>
</html>
