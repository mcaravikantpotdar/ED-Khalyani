<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title id="pageTitle">SaaS PMIS Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    body { background-color: #f4f7f9; font-family: 'Segoe UI', sans-serif; }
    .container { width: 98%; max-width: 1400px; margin-top: 20px; }
    .section-box { background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); border-top: 4px solid #1565c0; }
    .header-panel { background: #1565c0; color: white; padding: 15px 25px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    
    /* Atomic Save Button */
    .field-wrapper { position: relative; }
    .atomic-btn { 
      position: absolute; right: 5px; top: 15px; 
      display: none; cursor: pointer; color: #1565c0; z-index: 10;
      background: white; border-radius: 50%;
    }
    .atomic-btn:hover { transform: scale(1.2); color: #2e7d32; }
    
    /* Status Badges */
    .percent-badge { position: absolute; right: 35px; top: 18px; background: #2e7d32; color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; display: none; }
    
    /* Loader */
    #loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #1565c0; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }

    /* Admin Panel Styling */
    .admin-row { border-bottom: 1px solid #eee; padding: 10px 0; font-size: 0.9rem; }
    .u-case { text-transform: uppercase; }
  </style>
</head>
<body>

  <div id="loader"><div class="spinner"></div><p id="loaderText" style="margin-top:10px; font-weight:bold;">Initializing Mother Ship...</p></div>

  <div id="adminModal" class="modal modal-fixed-footer" style="width: 90%; max-height: 90%;">
    <div class="modal-content">
      <h4><i class="material-icons left">settings</i> Schema Orchestrator</h4>
      <p>Manage your Database Columns and Sections here.</p>
      <div id="schemaList">
        </div>
      <hr>
      <h5>Add New Column</h5>
      <div class="row">
        <div class="input-field col s12 m4"><input type="text" id="new_col_label"><label>Column Label</label></div>
        <div class="input-field col s12 m4">
          <select id="new_col_section">
            <option value="Personal">Personal</option>
            <option value="Contact & Family">Contact & Family</option>
            <option value="Academic">Academic</option>
            <option value="Professional">Professional</option>
            <option value="Service History">Service History</option>
          </select>
          <label>Section</label>
        </div>
        <div class="col s12 m4"><button class="btn blue" style="margin-top:20px;" onclick="addNewField()">Add Field</button></div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="modal-close btn-flat">Close</button>
    </div>
  </div>

  <div id="setupModal" class="modal">
    <div class="modal-content">
      <h4>System Setup</h4>
      <div id="idStep">
        <div class="input-field"><input type="text" id="sheet_id_input"><label>Google Sheet ID</label></div>
        <button class="btn blue" onclick="saveSheetId()">Connect</button>
      </div>
      <div id="provisionStep" style="display:none;">
        <div class="input-field"><input type="text" id="org_name_input"><label>Organization Name</label></div>
        <div class="input-field"><input type="password" id="admin_pass_input"><label>Set Admin Password</label></div>
        <button class="btn green" onclick="runProvisioning()">Build Database</button>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="header-panel" id="brandHeader" style="display:none;">
      <div>
        <h4 id="orgDisplay" style="margin:0; font-weight:bold;">Portal</h4>
        <span id="sheetDisplay" style="font-size:0.7rem; opacity:0.7;"></span>
      </div>
      <i class="material-icons" style="cursor:pointer;" onclick="openAdmin()">settings</i>
    </div>

    <div id="authZone" class="section-box" style="display:none;">
      <div class="row" style="margin-bottom:0">
        <div class="input-field col s12 m5"><input type="text" id="pmis_input"><label>PMIS CODE</label></div>
        <div class="input-field col s12 m5"><input type="text" id="dob_input" placeholder="DD-MM-YYYY"><label>DATE OF BIRTH</label></div>
        <div class="col s12 m2"><button class="btn-large blue darken-4 w100" style="width:100%;" onclick="loadRecord()">LOAD</button></div>
      </div>
    </div>

    <form id="mainForm"></form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    const MOTHER_SHIP = 'https://script.google.com/macros/s/AKfycbxk570Yj2DRGZcEWBB2E8BwHZOxDfO6i5TSF_NKyjso65ct2j0pbNiE5edQ-_aAyHi0sQ/exec';
    let CURRENT_ID = localStorage.getItem('pmis_sheet_id');
    let SCHEMA_CACHE = [];

    document.addEventListener('DOMContentLoaded', () => {
      M.Modal.init(document.querySelectorAll('.modal'), {dismissible: false});
      M.FormSelect.init(document.querySelectorAll('select'));
      if(!CURRENT_ID) { openSetup(); } else { initSystem(); }
    });

    function openSetup() {
      toggleLoader(false);
      M.Modal.getInstance(document.getElementById('setupModal')).open();
    }

    function saveSheetId() {
      CURRENT_ID = document.getElementById('sheet_id_input').value.trim();
      localStorage.setItem('pmis_sheet_id', CURRENT_ID);
      initSystem();
    }

    function initSystem() {
      toggleLoader(true, "Connecting...");
      callAPI({action: 'init', sheetId: CURRENT_ID}, (res) => {
        if(res.needsProvisioning) {
          document.getElementById('idStep').style.display = 'none';
          document.getElementById('provisionStep').style.display = 'block';
          openSetup();
        } else {
          M.Modal.getInstance(document.getElementById('setupModal')).close();
          SCHEMA_CACHE = res.schema;
          document.getElementById('orgDisplay').innerText = res.settings.ORG_NAME;
          document.getElementById('brandHeader').style.display = 'flex';
          document.getElementById('authZone').style.display = 'block';
          renderForm(res.schema);
        }
        toggleLoader(false);
      });
    }

    function renderForm(schema) {
      const form = document.getElementById('mainForm');
      form.innerHTML = '';
      const sections = [...new Set(schema.map(f => f.Section))];
      
      sections.forEach(sec => {
        const box = document.createElement('div');
        box.className = 'section-box';
        box.innerHTML = `<h5>${sec}</h5><div class="row"></div>`;
        const row = box.querySelector('.row');
        
        schema.filter(f => f.Section === sec).forEach(f => {
          const wrapper = document.createElement('div');
          wrapper.className = 'input-field col s12 m4 field-wrapper';
          wrapper.innerHTML = `
            <input type="text" name="${f.Label}" class="u-case field-input">
            <label>${f.Label}</label>
            ${f.Data_Type === 'MARKS' ? '<span class="percent-badge"></span>' : ''}
            <i class="material-icons atomic-btn" onclick="saveField(this)">save</i>
          `;
          row.appendChild(wrapper);
        });
        form.appendChild(box);
      });
      M.updateTextFields();
      attachInputListeners();
    }

    function attachInputListeners() {
      document.querySelectorAll('.field-input').forEach(input => {
        input.addEventListener('input', (e) => {
          const btn = e.target.parentElement.querySelector('.atomic-btn');
          btn.style.display = 'block';
          btn.innerHTML = 'save';
          btn.style.color = '#1565c0';
          
          if(e.target.name.includes('Marks')) {
            const badge = e.target.parentElement.querySelector('.percent-badge');
            const p = e.target.value.split('/');
            if(p.length === 2 && p[1]>0) {
              badge.innerText = ((p[0]/p[1])*100).toFixed(1)+'%';
              badge.style.display = 'block';
            }
          }
        });
      });
    }

    function saveField(btn) {
      const input = btn.parentElement.querySelector('input');
      const pmis = document.getElementById('pmis_input').value;
      if(!pmis) return alert("Load a record first!");

      btn.innerHTML = 'sync';
      btn.style.opacity = '0.5';

      callAPI({
        action: 'atomicSave',
        sheetId: CURRENT_ID,
        pmis: pmis,
        fieldName: input.name,
        newValue: input.value.toUpperCase()
      }, (res) => {
        if(res.success) {
          btn.innerHTML = 'check_circle';
          btn.style.color = '#2e7d32';
          btn.style.opacity = '1';
          setTimeout(() => { btn.style.display = 'none'; }, 2000);
        }
      });
    }

    function loadRecord() {
      const pmis = document.getElementById('pmis_input').value;
      const dob = document.getElementById('dob_input').value;
      toggleLoader(true, "Searching...");
      callAPI({action: 'search', sheetId: CURRENT_ID, pmis: pmis, dob: dob}, (res) => {
        toggleLoader(false);
        if(res.error) return alert(res.error);
        if(res.notFound) return M.toast({html: 'No record found'});
        
        Object.keys(res).forEach(key => {
          const el = document.getElementsByName(key)[0];
          if(el) { el.value = res[key]; el.dispatchEvent(new Event('input')); }
        });
        document.querySelectorAll('.atomic-btn').forEach(b => b.style.display = 'none');
        M.updateTextFields();
      });
    }

    // --- ADMIN ORCHESTRATOR ---
    function openAdmin() {
      const pass = prompt("Enter Admin Password:");
      callAPI({action: 'init', sheetId: CURRENT_ID}, (res) => {
        if(String(pass) === String(res.settings.ADMIN_PASSWORD)) {
          renderSchemaEditor(res.schema);
          M.Modal.getInstance(document.getElementById('adminModal')).open();
        } else { alert("Unauthorized"); }
      });
    }

    function renderSchemaEditor(schema) {
      const list = document.getElementById('schemaList');
      list.innerHTML = '<div class="row blue-text" style="font-weight:bold;"><div class="col s6">Field Label</div><div class="col s6">Current Section</div></div>';
      schema.forEach(f => {
        const div = document.createElement('div');
        div.className = 'admin-row row';
        div.innerHTML = `<div class="col s6">${f.Label}</div><div class="col s6 grey-text text-darken-2">${f.Section}</div>`;
        list.appendChild(div);
      });
    }

    function addNewField() {
      const label = document.getElementById('new_col_label').value;
      const section = document.getElementById('new_col_section').value;
      if(!label) return alert("Enter a label");

      toggleLoader(true, "Modifying Database...");
      callAPI({
        action: 'manageSchema',
        subAction: 'addColumn',
        sheetId: CURRENT_ID,
        payload: { label: label, section: section, type: 'TEXT_UC', order: 999 }
      }, (res) => {
        if(res.success) location.reload();
      });
    }

    // --- UTILS ---
    function callAPI(data, cb) {
      fetch(MOTHER_SHIP, { method: 'POST', body: JSON.stringify(data) })
        .then(res => res.json()).then(res => cb(res))
        .catch(e => { toggleLoader(false); alert("Mother Ship Error: " + e); });
    }

    function toggleLoader(s, t) {
      document.getElementById('loader').style.display = s ? 'flex' : 'none';
      if(t) document.getElementById('loaderText').innerText = t;
    }

    function runProvisioning() {
      const org = document.getElementById('org_name_input').value;
      const pass = document.getElementById('admin_pass_input').value;
      callAPI({action: 'provision', sheetId: CURRENT_ID, orgName: org, password: pass}, () => location.reload());
    }
  </script>
</body>
</html>
