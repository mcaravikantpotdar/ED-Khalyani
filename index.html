<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>PMIS Command v6.1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <style>
    :root { --primary: #0f172a; --accent: #3b82f6; --error: #ef4444; }
    body { background: #f8fafc; font-family: 'Inter', sans-serif; }
    #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
    .pulse-ring { width: 80px; height: 80px; border: 4px solid #f1f5f9; border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    #verboseText { margin-top: 25px; font-weight: 600; color: var(--primary); text-align: center; max-width: 80%; }
    .error-text { color: var(--error) !important; font-size: 0.9rem; margin-top: 10px; }
    
    /* Layout */
    .app-header { background: var(--primary); color: white; padding: 40px 0; border-radius: 0 0 24px 24px; margin-bottom: 30px; }
    .section-card { background: white; border-radius: 16px; padding: 25px; margin-bottom: 25px; border: 1px solid #e2e8f0; }
    .field-wrapper { position: relative; }
    .atomic-btn { position: absolute; right: 10px; top: 12px; opacity: 0; transform: translateX(10px); transition: 0.3s; cursor: pointer; color: var(--accent); background: white; }
    .atomic-btn.visible { opacity: 1; transform: translateX(0); }
    .u-case { text-transform: uppercase; }
  </style>
</head>
<body>

  <div id="loader">
    <div class="pulse-ring" id="ring"></div>
    <p id="verboseText">Initiating Handshake...</p>
    <button id="retryBtn" class="btn red" style="display:none; margin-top:20px;" onclick="location.reload()">Retry Connection</button>
  </div>

  <div id="setupModal" class="modal">
    <div class="modal-content">
      <h4 id="setupHeader">System Connection</h4>
      <div id="stepConnect">
        <div class="input-field"><input type="text" id="setup_sid"><label>Google Sheet ID</label></div>
        <button class="btn blue" style="width:100%" onclick="saveSid()">Connect Sheet</button>
      </div>
      <div id="stepBuild" style="display:none;">
        <div class="input-field"><input type="text" id="setup_org"><label>Organization Name</label></div>
        <div class="input-field"><input type="password" id="setup_pass"><label>Admin Password</label></div>
        <button class="btn green" style="width:100%" onclick="runDeployment()">Launch Provisioning</button>
      </div>
    </div>
  </div>

  <div id="appBody" style="display:none;">
    <div class="app-header"><div class="container"><h3 id="dispOrg" style="margin:0; font-weight:800;">Portal</h3></div></div>
    <div class="container">
      <div class="section-card" style="margin-top:-50px;">
        <div class="row" style="margin-bottom:0">
          <div class="input-field col s12 m5"><input type="text" id="pmis_in"><label>PMIS CODE</label></div>
          <div class="input-field col s12 m5"><input type="text" id="dob_in" placeholder="DD-MM-YYYY"><label>DOB</label></div>
          <div class="col s12 m2"><button class="btn-large blue accent-4" style="width:100%" onclick="searchRec()">LOAD</button></div>
        </div>
      </div>
      <div id="formContainer"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script>
    const MOTHER_SHIP = 'https://script.google.com/macros/s/AKfycbxk570Yj2DRGZcEWBB2E8BwHZOxDfO6i5TSF_NKyjso65ct2j0pbNiE5edQ-_aAyHi0sQ/exec';
    let SID = localStorage.getItem('pmis_v6_sid');

    window.onload = () => {
      M.Modal.init(document.querySelectorAll('.modal'), {dismissible: false});
      if(!SID) { stopLoader("Welcome. Please provide a Sheet ID."); openSetup(); } 
      else { startup(); }
    };

    function startup() {
      setMsg("Connecting to Mother Ship...");
      callAPI({action: 'checkStatus', sheetId: SID}, (res) => {
        if(res.error) return stopLoader("Mother Ship Error: " + res.error, true);
        if(res.status === "NEW") { stopLoader("Ready for Provisioning."); openSetup(true); }
        else { setMsg("Rehydrating DNA..."); loadData(); }
      });
    }

    function loadData() {
      callAPI({action: 'init', sheetId: SID}, (res) => {
        if(res.error) return stopLoader("Init Error: " + res.error, true);
        document.getElementById('dispOrg').innerText = res.settings.ORG_NAME;
        render(res.schema);
        document.getElementById('loader').style.display = 'none';
        document.getElementById('appBody').style.display = 'block';
      });
    }

    function render(schema) {
      const container = document.getElementById('formContainer');
      const sections = [...new Set(schema.map(f => f.Section))].sort();
      sections.forEach(sec => {
        const card = document.createElement('div');
        card.className = 'section-card';
        card.innerHTML = `<h5>${sec}</h5><div class="row"></div>`;
        const row = card.querySelector('.row');
        schema.filter(f => f.Section === sec).sort((a,b) => a.Order - b.Order).forEach(f => {
          row.innerHTML += `<div class="input-field col s12 m4 field-wrapper">
            <input type="text" name="${f.ID}" class="u-case d-in"><label>${f.Label}</label>
            <i class="material-icons atomic-btn" onclick="saveOne(this)">save</i>
          </div>`;
        });
        container.appendChild(card);
      });
      M.updateTextFields();
      document.querySelectorAll('.d-in').forEach(i => i.oninput = (e) => e.target.parentElement.querySelector('.atomic-save-btn')?.classList.add('visible'));
    }

    function callAPI(data, cb) {
      fetch(MOTHER_SHIP, {method: 'POST', body: JSON.stringify(data)})
        .then(r => r.json()).then(cb)
        .catch(e => stopLoader("Network Signal Lost. " + e, true));
    }

    function setMsg(m) { document.getElementById('verboseText').innerText = m; }
    
    function stopLoader(m, isErr = false) {
      document.getElementById('ring').style.display = isErr ? 'none' : 'block';
      setMsg(m);
      if(isErr) {
        document.getElementById('verboseText').classList.add('error-text');
        document.getElementById('retryBtn').style.display = 'block';
      }
    }

    function openSetup(isProv = false) {
      document.getElementById('loader').style.display = 'none';
      if(isProv) {
        document.getElementById('stepConnect').style.display = 'none';
        document.getElementById('stepBuild').style.display = 'block';
        document.getElementById('setupHeader').innerText = "Provisioning Required";
      }
      M.Modal.getInstance(document.getElementById('setupModal')).open();
    }

    function saveSid() {
      SID = document.getElementById('setup_sid').value.trim();
      localStorage.setItem('pmis_v6_sid', SID);
      location.reload();
    }

    function runDeployment() {
      const org = document.getElementById('setup_org').value;
      const pass = document.getElementById('setup_pass').value;
      document.getElementById('setupModal').style.display = 'none';
      document.getElementById('loader').style.display = 'flex';
      setMsg("Building Architecture...");
      callAPI({action: 'provision', sheetId: SID, orgName: org, password: pass}, () => location.reload());
    }
  </script>
</body>
</html>
